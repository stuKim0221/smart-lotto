name: Update Lotto Data

on:
  schedule:
    - cron: '50 11 * * 6'   # 매주 토 11:50 UTC = 토 20:50 KST
  workflow_dispatch:         # 수동 실행도 허용

concurrency:
  group: update-lotto-data
  cancel-in-progress: true

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write         # 브랜치 푸시
      pull-requests: write    # PR 생성/업데이트

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install requests pandas

    - name: Run data update script
      run: python scripts/update_lotto_data.py

    - name: Commit changes to bot branch
      run: |
        set -e
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        # 전용 브랜치(있으면 체크아웃, 없으면 생성)
        git checkout -B bot/lotto-data
        git add draw_kor.csv
        if git diff --staged --quiet; then
          echo "NO_CHANGES=true" >> $GITHUB_ENV
          echo "No changes to commit"
        else
          git commit -m "Auto-update lotto data - $(date -u)"
        fi

    - name: Push bot branch
      if: env.NO_CHANGES != 'true'
      run: |
        git fetch origin
        # 원격 브랜치가 있으면 최신 반영 후 푸시
        if git ls-remote --exit-code --heads origin bot/lotto-data; then
          git pull --rebase origin bot/lotto-data || true
        fi
        git push origin HEAD:bot/lotto-data

    - name: Create or update Pull Request
      if: env.NO_CHANGES != 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        branch: bot/lotto-data
        base: main
        title: "Auto-update lotto data"
        body: "자동 로또 데이터 업데이트 PR (bot/lotto-data → main)"
        commit-message: "Auto-update lotto data - $(date -u)"
        labels: "automation, data"
        delete-branch: false
        draft: false
